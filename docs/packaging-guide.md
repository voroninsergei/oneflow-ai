# OneFlow.AI - Modern Packaging Migration Guide
## Переход на современный Python packaging

---

## 🎯 Problems with Current Approach

### Old: `setup.py`
```python
# setup.py - deprecated approach
setup(
    name="oneflow-ai",
    install_requires=[...],  # No version locking
    # No extras, no lock file, no reproducible builds
)
```

**Problems:**
- ❌ No dependency locking
- ❌ No reproducible builds
- ❌ Manual `requirements.txt` management
- ❌ No extras/optional dependencies
- ❌ Deprecated by PEP 517/518/621

---

## ✅ Modern Solution: `pyproject.toml`

### Benefits:
- ✅ **PEP 621** compliant (standard metadata format)
- ✅ **Dependency locking** (reproducible builds)
- ✅ **Optional dependencies** (extras) for modular installation
- ✅ **Tool configuration** in one file
- ✅ **Build backend agnostic** (setuptools, poetry, flit, hatch)

---

## 🔄 Migration Steps

### Step 1: Choose Build System

You have 2 modern options:

#### Option A: Setuptools + pip-tools (Conservative)
- Uses familiar tools
- Good for existing projects
- Lock with `pip-compile`

#### Option B: Poetry (Modern)
- All-in-one tool
- Better dependency resolution
- Built-in lock file (`poetry.lock`)

---

## 📦 Option A: Setuptools + pip-tools

### File Structure:
```
OneFlow.AI/
├── pyproject.toml           # ← Modern metadata (replaces setup.py)
├── requirements/
│   ├── base.txt             # Core dependencies
│   ├── api.txt              # -r base.txt + API providers
│   ├── web.txt              # -r base.txt + FastAPI
│   ├── db.txt               # -r base.txt + SQLAlchemy
│   ├── postgres.txt         # -r db.txt + psycopg2
│   ├── auth.txt             # -r base.txt + JWT
│   ├── dev.txt              # Development tools
│   ├── prod.txt             # Production deployment
│   └── docs.txt             # Documentation
├── requirements.txt         # → Legacy compatibility (optional)
├── requirements.lock        # ← Generated by pip-compile
└── setup.py                 # ← DELETE (no longer needed)
```

### Installation Steps:

```bash
# 1. Install pip-tools
pip install pip-tools

# 2. Generate lock file
pip-compile pyproject.toml -o requirements.lock

# 3. Install for development
pip install -e ".[dev]"

# 4. Install for production
pip install -e ".[api,web,postgres,auth]"
```

### Generate Locked Requirements:

```bash
# Lock all dependencies
pip-compile pyproject.toml -o requirements.lock

# Lock with extras
pip-compile --extra api --extra web pyproject.toml -o requirements.lock

# Update locks
pip-compile --upgrade pyproject.toml -o requirements.lock

# Sync installed packages to match lock
pip-sync requirements.lock
```

---

## 📦 Option B: Poetry (Recommended)

### Why Poetry:
- ✅ Automatic lock file (`poetry.lock`)
- ✅ Better dependency resolution
- ✅ Virtual environment management
- ✅ Publishing to PyPI
- ✅ Single command for everything

### Installation:

```bash
# Install Poetry
curl -sSL https://install.python-poetry.org | python3 -

# Or via pip
pip install poetry

# Configure Poetry
poetry config virtualenvs.in-project true  # Create .venv in project
```

### File Structure:
```
OneFlow.AI/
├── pyproject.toml           # ← Poetry configuration
├── poetry.lock              # ← Auto-generated lock file
└── setup.py                 # ← DELETE
```

### Usage:

```bash
# 1. Initialize (if starting fresh)
poetry init

# 2. Install dependencies
poetry install

# 3. Install with extras
poetry install --extras "api web db auth"

# 4. Install all extras
poetry install --all-extras

# 5. Add new dependency
poetry add requests

# 6. Add optional dependency
poetry add --optional openai

# 7. Update dependencies
poetry update

# 8. Show dependency tree
poetry show --tree

# 9. Run commands in virtual env
poetry run pytest
poetry run python -m oneflow.cli

# 10. Build package
poetry build

# 11. Publish to PyPI
poetry publish
```

---

## 📊 Comparison Matrix

| Feature | setup.py | setuptools + pip-tools | Poetry |
|---------|----------|------------------------|--------|
| **Metadata** | Python | TOML | TOML |
| **Lock File** | ❌ None | ✅ requirements.lock | ✅ poetry.lock |
| **Extras** | ⚠️ Manual | ✅ Auto | ✅ Auto |
| **Dependency Resolution** | ❌ Weak | ✅ Good | ✅ Excellent |
| **Virtual Env** | ❌ Manual | ❌ Manual | ✅ Built-in |
| **Build** | ❌ Manual | ✅ pip | ✅ Built-in |
| **Publish** | ❌ Manual | ❌ twine | ✅ Built-in |
| **Learning Curve** | Low | Medium | Medium |
| **Community** | Declining | Growing | Growing |

---

## 🚀 Recommended Installation Patterns

### Development:
```bash
# Setuptools
pip install -e ".[dev,api,web,db,auth]"

# Poetry
poetry install --all-extras
```

### Production (minimal):
```bash
# Setuptools
pip install -e ".[api,web,postgres,auth]"

# Poetry
poetry install --only main --extras "api web postgres auth"
```

### Production (full):
```bash
# Setuptools
pip install -e ".[all]"

# Poetry
poetry install --all-extras
```

### CI/CD:
```bash
# Setuptools + pip-tools
pip install pip-tools
pip-sync requirements.lock

# Poetry
poetry install --no-dev --no-root
```

---

## 🔐 Lock File Best Practices

### Why Lock Files Matter:
- ✅ **Reproducible builds** across environments
- ✅ **Version pinning** prevents breaking changes
- ✅ **Security** - know exact versions installed
- ✅ **CI/CD** - same dependencies everywhere

### When to Update:
```bash
# Weekly/monthly dependency updates
pip-compile --upgrade  # setuptools
poetry update          # poetry

# Security patches only
pip-compile --upgrade-package requests
poetry update requests

# New dependency added
pip-compile  # Regenerate lock
poetry add requests  # Auto-updates lock
```

### Commit Lock Files:
```bash
git add poetry.lock requirements.lock
git commit -m "chore: update dependencies"
```

---

## 📝 Migration Checklist

### Phase 1: Preparation
- [ ] Backup current `setup.py` and `requirements.txt`
- [ ] Review all current dependencies
- [ ] Identify optional dependencies (extras)
- [ ] Choose build system (setuptools vs poetry)

### Phase 2: Create pyproject.toml
- [ ] Create `pyproject.toml` with metadata
- [ ] Define core dependencies
- [ ] Define optional dependencies (extras)
- [ ] Configure dev tools (black, pytest, mypy)

### Phase 3: Generate Lock Files
- [ ] Install pip-tools or Poetry
- [ ] Generate lock file
- [ ] Test installation from lock

### Phase 4: Test
- [ ] Test base installation: `pip install -e .`
- [ ] Test with extras: `pip install -e ".[dev]"`
- [ ] Run test suite: `pytest`
- [ ] Test in clean virtual environment

### Phase 5: Update CI/CD
- [ ] Update GitHub Actions workflow
- [ ] Update Docker builds
- [ ] Update deployment scripts
- [ ] Update documentation

### Phase 6: Cleanup
- [ ] Delete `setup.py`
- [ ] Update `README.md` installation instructions
- [ ] Update `CONTRIBUTING.md`
- [ ] Archive old `requirements.txt` (optional)

---

## 🔄 CI/CD Integration

### GitHub Actions (setuptools):

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.lock') }}
    
    - name: Install dependencies
      run: |
        pip install pip-tools
        pip-sync requirements.lock
    
    - name: Run tests
      run: pytest
```

### GitHub Actions (Poetry):

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.7.0
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'poetry'
    
    - name: Install dependencies
      run: poetry install --all-extras
    
    - name: Run tests
      run: poetry run pytest
```

---

## 🐳 Docker Integration

### Setuptools + pip-tools:

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install pip-tools
RUN pip install --no-cache-dir pip-tools

# Copy lock file
COPY requirements.lock .

# Install dependencies from lock
RUN pip-sync requirements.lock

# Copy application
COPY . .

# Install application
RUN pip install --no-cache-dir -e ".[api,web,postgres,auth]"

CMD ["uvicorn", "oneflow.web_server:app", "--host", "0.0.0.0"]
```

### Poetry:

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install Poetry
RUN pip install --no-cache-dir poetry==1.7.0

# Copy dependency files
COPY pyproject.toml poetry.lock ./

# Install dependencies only
RUN poetry config virtualenvs.create false \
    && poetry install --no-dev --no-root --extras "api web postgres auth"

# Copy application
COPY . .

# Install application
RUN poetry install --no-dev

CMD ["poetry", "run", "uvicorn", "oneflow.web_server:app", "--host", "0.0.0.0"]
```

---

## 📚 Additional Resources

### Documentation:
- [PEP 621 - Project Metadata](https://peps.python.org/pep-0621/)
- [PEP 517 - Build Backend](https://peps.python.org/pep-0517/)
- [Poetry Documentation](https://python-poetry.org/docs/)
- [pip-tools Documentation](https://github.com/jazzband/pip-tools)

### Migration Guides:
- [Moving to pyproject.toml](https://setuptools.pypa.io/en/latest/userguide/pyproject_config.html)
- [Poetry Migration Guide](https://python-poetry.org/docs/managing-dependencies/)

---

## 🎯 Recommendation for OneFlow.AI

### For This Project: **Poetry** ✅

**Why:**
1. ✅ Modern, actively maintained
2. ✅ Better dependency resolution
3. ✅ Automatic lock file
4. ✅ Built-in virtual env management
5. ✅ Easier for contributors
6. ✅ Single command for all operations

### Migration Command:

```bash
# 1. Install Poetry
curl -sSL https://install.python-poetry.org | python3 -

# 2. Initialize from existing setup.py
poetry init --name oneflow-ai

# 3. Import dependencies
poetry add pytest
poetry add --group dev black pytest-cov mypy
poetry add --optional openai anthropic fastapi

# 4. Generate lock file
poetry lock

# 5. Install
poetry install --all-extras

# 6. Done!
```

---

## ✅ Final Checklist

- [ ] Choose build system (Poetry recommended)
- [ ] Create `pyproject.toml`
- [ ] Generate lock file
- [ ] Test installation
- [ ] Update CI/CD
- [ ] Update Docker
- [ ] Update documentation
- [ ] Delete `setup.py`
- [ ] Commit changes

---

**Result: Modern, maintainable, reproducible Python packaging! 🎉**